<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>band_selection_controller.js - RDoc Documentation</title>

  <meta name="keywords" content="ruby,documentation,band_selection_controller.js">
  <meta name="description" content="band_selection_controller.js: String, }; connect() { this. selectedBands = new Set(); this.">


<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/navigation.js" defer></script>
<script src="../../../js/search.js" defer></script>
<script src="../../../js/search_index.js" defer></script>
<script src="../../../js/searcher.js" defer></script>
<script src="../../../js/darkfish.js" defer></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
  
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><details open><summary>app</summary>
    <ul class="link-list">
      <li><a href="../../../app/assets/stylesheets/application_css.html">application.css</a>
      <li><a href="../../../app/assets/stylesheets/band_selection_css.html">band_selection.css</a>
      <li><a href="../../../app/assets/stylesheets/band_selection_scss.html">band_selection.scss</a>
      <li><a href="../../../app/assets/stylesheets/custom_css.html">custom.css</a>
      <li><a href="../../../app/javascript/application_js.html">application.js</a>
      <li><a href="../../../app/javascript/controllers/application_js.html">application.js</a>
      <li><a href="../../../app/javascript/controllers/band_selection_controller_js.html">band_selection_controller.js</a>
      <li><a href="../../../app/javascript/controllers/band_times_controller_js.html">band_times_controller.js</a>
      <li><a href="../../../app/javascript/controllers/calendar_controller_js.html">calendar_controller.js</a>
      <li><a href="../../../app/javascript/controllers/form_validation_controller_js.html">form_validation_controller.js</a>
      <li><a href="../../../app/javascript/controllers/hello_controller_js.html">hello_controller.js</a>
      <li><a href="../../../app/javascript/controllers/index_js.html">index.js</a>
      <li><a href="../../../app/javascript/controllers/service_worker_js.html">service_worker.js</a>
      <li><a href="../../../app/views/pwa/service-worker_js.html">service-worker.js</a>
    </ul></details>
  </ul>
</div>


  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.14.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

</nav>

<main role="main" aria-label="Page app/javascript/controllers/band_selection_controller.js">

<p>import { Controller } from “@hotwired/stimulus”;</p>

<p>export default class extends Controller {</p>

<pre>static targets = [
  &quot;search&quot;,
  &quot;results&quot;,
  &quot;list&quot;,
  &quot;noMessage&quot;,
  &quot;idsContainer&quot;,
  &quot;loading&quot;,
  &quot;count&quot;,
];
static values = {
  searchUrl: String,
  artistInfoUrl: String,
  newBandUrl: String,
};

connect() {
  this.selectedBands = new Set();
  this.bandsData = new Map(); // Store band data for event emitting
  this.searchTimeout = null;
  this.searchDropdown = null;
  this.currentFocusIndex = -1; // For keyboard navigation
  this.updateSelectedCount();
  this.updateNoBandsMessage();

  // Add keyboard event listeners
  this.searchTarget.addEventListener(
    &quot;keydown&quot;,
    this.handleSearchKeydown.bind(this)
  );

  // Handle when focus leaves the search input
  this.searchTarget.addEventListener(&quot;blur&quot;, (e) =&gt; {
    // Small delay to check if focus moved to a search result
    setTimeout(() =&gt; {
      if (
        !this.searchDropdown ||
        !this.searchDropdown.contains(document.activeElement)
      ) {
        // Focus left the search area, close dropdown after delay
        // Only close if focus didn&#39;t move to a dropdown item
        setTimeout(() =&gt; {
          if (
            !this.searchDropdown ||
            !this.searchDropdown.contains(document.activeElement)
          ) {
            this.closeSearchDropdown();
          }
        }, 150);
      }
    }, 50);
  });

  // Pre-populate bands if they exist
  const prePopulatedBands = JSON.parse(this.element.dataset.bands || &quot;[]&quot;);
  prePopulatedBands.forEach((band) =&gt; {
    this.addBand(band);
  });

  // Emit initial event with pre-populated bands
  this.emitBandsChangedEvent();
}

disconnect() {
  // Clean up event listeners
  this.searchTarget.removeEventListener(
    &quot;keydown&quot;,
    this.handleSearchKeydown.bind(this)
  );
  // Note: blur event listener will be automatically cleaned up when element is removed
}

handleSearchKeydown(event) {
  if (!this.searchDropdown) return;

  const resultItems = this.searchDropdown.querySelectorAll(
    &quot;.search-result-item&quot;
  );

  switch (event.key) {
    case &quot;ArrowDown&quot;:
      event.preventDefault();
      this.currentFocusIndex = Math.min(
        this.currentFocusIndex + 1,
        resultItems.length - 1
      );
      this.updateFocus(resultItems);
      break;
    case &quot;ArrowUp&quot;:
      event.preventDefault();
      this.currentFocusIndex = Math.max(this.currentFocusIndex - 1, -1);
      this.updateFocus(resultItems);
      break;
    case &quot;Enter&quot;:
      event.preventDefault();
      if (
        this.currentFocusIndex &gt;= 0 &amp;&amp;
        resultItems[this.currentFocusIndex]
      ) {
        resultItems[this.currentFocusIndex].click();
      }
      break;
    case &quot;Escape&quot;:
      event.preventDefault();
      this.closeSearchDropdown();
      this.currentFocusIndex = -1;
      break;
    case &quot;Tab&quot;:
      // Let tab work naturally through focusable elements in the dropdown
      if (resultItems.length &gt; 0) {
        // If we&#39;re tabbing forward and no item is focused yet, focus the first item
        if (this.currentFocusIndex === -1 &amp;&amp; !event.shiftKey) {
          event.preventDefault();
          this.currentFocusIndex = 0;
          this.updateFocus(resultItems);
          resultItems[0].focus();
        }
      }
      break;
  }
}

updateFocus(resultItems) {
  // Remove focus from all items
  resultItems.forEach((item, index) =&gt; {
    item.classList.remove(&quot;keyboard-focused&quot;);
    if (index === this.currentFocusIndex) {
      item.classList.add(&quot;keyboard-focused&quot;);
      item.scrollIntoView({ block: &quot;nearest&quot; });
    }
  });
}

search() {
  const query = this.searchTarget.value.trim();
  this.currentFocusIndex = -1; // Reset focus index

  // Clear any existing timeout
  if (this.searchTimeout) {
    clearTimeout(this.searchTimeout);
  }

  // If query is empty, close dropdown and return
  if (query === &quot;&quot;) {
    this.closeSearchDropdown();
    return;
  }

  // Show loading indicator inside dropdown
  const dropdown = this.createSearchDropdown();
  this.showLoadingInDropdown(dropdown);

  // Set a timeout to prevent too many API calls
  this.searchTimeout = setTimeout(() =&gt; {
    // Call Spotify API
    fetch(`${this.searchUrlValue}?query=${encodeURIComponent(query)}`)
      .then((response) =&gt; response.json())
      .then((data) =&gt; {
        this.renderSearchResults(data);
      })
      .catch((error) =&gt; {
        console.error(&quot;Error searching artists:&quot;, error);

        // Show error in dropdown
        const dropdown = this.createSearchDropdown();
        dropdown.innerHTML =
          &#39;&lt;div class=&quot;p-3 text-center&quot;&gt;&lt;p class=&quot;text-danger mb-0&quot;&gt;Error searching for artists&lt;/p&gt;&lt;/div&gt;&#39;;
      });
  }, 500); // 500ms delay
}

searchFocus(event) {
  const query = event.currentTarget.value.trim();
  this.currentFocusIndex = -1; // Reset focus index

  if (query !== &quot;&quot;) {
    // Show loading in dropdown
    const dropdown = this.createSearchDropdown();
    this.showLoadingInDropdown(dropdown);

    fetch(`${this.searchUrlValue}?query=${encodeURIComponent(query)}`)
      .then((response) =&gt; response.json())
      .then((data) =&gt; {
        this.renderSearchResults(data);
      })
      .catch((error) =&gt; {
        console.error(&quot;Error searching artists:&quot;, error);
        const dropdown = this.createSearchDropdown();
        dropdown.innerHTML =
          &#39;&lt;div class=&quot;p-3 text-center&quot;&gt;&lt;p class=&quot;text-danger mb-0&quot;&gt;Error searching for artists&lt;/p&gt;&lt;/div&gt;&#39;;
      });
  }
}

selectBand(event) {
  const spotifyId = event.currentTarget.dataset.spotifyId;

  // Close dropdown immediately when a band is selected
  this.closeSearchDropdown();
  this.searchTarget.value = &quot;&quot;;
  this.currentFocusIndex = -1;

  // Create a loading indicator that appears directly in the form area
  if (this.hasLoadingTarget) {
    this.loadingTarget.style.display = &quot;block&quot;;
  }

  // Get detailed artist info
  fetch(
    `${this.artistInfoUrlValue}?spotify_id=${encodeURIComponent(spotifyId)}`
  )
    .then((response) =&gt; response.json())
    .then((data) =&gt; {
      if (data.band_id &amp;&amp; !this.selectedBands.has(data.band_id.toString())) {
        this.addBand({
          id: data.band_id,
          name: data.name,
          image_url: data.photo_url,
        });
      }
      // Hide loading indicator
      if (this.hasLoadingTarget) {
        this.loadingTarget.style.display = &quot;none&quot;;
      }
    })
    .catch((error) =&gt; {
      console.error(&quot;Error fetching artist info:&quot;, error);
      if (this.hasLoadingTarget) {
        this.loadingTarget.style.display = &quot;none&quot;;
      }
    });
}

// Show loading spinner inside the dropdown
showLoadingInDropdown(dropdown) {
  dropdown.innerHTML = `
    &lt;div class=&quot;spinner-container&quot;&gt;
      &lt;div class=&quot;spinner-border text-primary&quot; role=&quot;status&quot;&gt;
        &lt;span class=&quot;visually-hidden&quot;&gt;Loading...&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `;
}

createNewBand() {
  window.location.href = this.newBandUrlValue;
}

removeBand(event) {
  const bandId = event.currentTarget.dataset.id;
  this.selectedBands.delete(bandId.toString());
  this.bandsData.delete(bandId.toString());

  // Remove visual item
  const item = document.getElementById(`band-item-${bandId}`);
  if (item) item.remove();

  // Remove hidden input
  const input = document.getElementById(`band-input-${bandId}`);
  if (input) input.remove();

  // Update no bands message
  this.updateNoBandsMessage();
  this.updateSelectedCount();

  // Emit bands changed event
  this.emitBandsChangedEvent();
}

// Helper methods
closeSearchDropdown() {
  if (this.searchDropdown) {
    this.searchDropdown.remove();
    this.searchDropdown = null;
    this.currentFocusIndex = -1;
  }
}

createSearchDropdown() {
  // Remove existing dropdown if it exists
  this.closeSearchDropdown();

  // Create new dropdown
  this.searchDropdown = document.createElement(&quot;div&quot;);
  this.searchDropdown.className = &quot;search-results-dropdown&quot;;
  this.searchDropdown.setAttribute(&quot;role&quot;, &quot;listbox&quot;);
  this.searchDropdown.setAttribute(&quot;aria-label&quot;, &quot;Search results&quot;);
  this.resultsTarget.appendChild(this.searchDropdown);

  // Close dropdown when clicking outside
  document.addEventListener(
    &quot;click&quot;,
    (e) =&gt; {
      if (
        !this.resultsTarget.contains(e.target) &amp;&amp;
        !this.searchTarget.contains(e.target)
      ) {
        this.closeSearchDropdown();
      }
    },
    { once: true }
  );

  return this.searchDropdown;
}

renderSearchResults(results) {
  // Clear existing results and create dropdown container
  const dropdown = this.createSearchDropdown();

  if (results.length === 0) {
    // No results found message
    const noResultsMessage = document.createElement(&quot;div&quot;);
    noResultsMessage.className = &quot;p-3 text-center&quot;;
    noResultsMessage.innerHTML =
      &#39;&lt;p class=&quot;text-muted mb-0&quot;&gt;No bands found matching your search.&lt;/p&gt;&#39;;
    dropdown.appendChild(noResultsMessage);
  } else {
    // Show search results
    const resultsContainer = document.createElement(&quot;div&quot;);

    results.forEach((band, index) =&gt; {
      const item = document.createElement(&quot;div&quot;);
      item.className = &quot;band-search-result-item search-result-item&quot;;
      item.dataset.action = &quot;click-&gt;band-selection#selectBand&quot;;
      item.dataset.spotifyId = band.spotify_id;

      // Make the item focusable
      item.setAttribute(&quot;tabindex&quot;, &quot;0&quot;);
      item.setAttribute(&quot;role&quot;, &quot;option&quot;);
      item.setAttribute(&quot;aria-label&quot;, `Select band ${band.name}`);

      // Add keyboard event listeners for individual items
      item.addEventListener(&quot;keydown&quot;, (e) =&gt; {
        if (e.key === &quot;Enter&quot; || e.key === &quot; &quot;) {
          e.preventDefault();
          item.click();
        }
      });

      // Add focus and blur event listeners
      item.addEventListener(&quot;focus&quot;, () =&gt; {
        this.currentFocusIndex = index;
        this.updateFocus(dropdown.querySelectorAll(&quot;.search-result-item&quot;));
      });

      // Band image
      const img = document.createElement(&quot;img&quot;);
      img.className = &quot;band-img&quot;;
      img.src = band.image_url || &quot;https://via.placeholder.com/40&quot;;
      img.alt = band.name;
      img.onerror = function () {
        this.src = &quot;https://via.placeholder.com/40&quot;;
      };

      // Band name
      const bandInfo = document.createElement(&quot;div&quot;);
      bandInfo.className = &quot;band-info&quot;;
      bandInfo.textContent = band.name;

      item.appendChild(img);
      item.appendChild(bandInfo);
      resultsContainer.appendChild(item);
    });

    dropdown.appendChild(resultsContainer);
  }

  // Always add &quot;Create New&quot; as the last option - make it sticky
  const createNewItem = document.createElement(&quot;div&quot;);
  createNewItem.className =
    &quot;band-search-result-item search-result-item create-new&quot;;
  createNewItem.innerHTML =
    &#39;&lt;i class=&quot;fas fa-plus-circle me-2&quot;&gt;&lt;/i&gt; None found? Create New&#39;;
  createNewItem.dataset.action = &quot;click-&gt;band-selection#createNewBand&quot;;

  // Make the create new item focusable
  createNewItem.setAttribute(&quot;tabindex&quot;, &quot;0&quot;);
  createNewItem.setAttribute(&quot;role&quot;, &quot;option&quot;);
  createNewItem.setAttribute(&quot;aria-label&quot;, &quot;Create new band&quot;);

  // Add keyboard event listeners for create new item
  createNewItem.addEventListener(&quot;keydown&quot;, (e) =&gt; {
    if (e.key === &quot;Enter&quot; || e.key === &quot; &quot;) {
      e.preventDefault();
      createNewItem.click();
    }
  });

  // Add focus event listener for create new item
  createNewItem.addEventListener(&quot;focus&quot;, () =&gt; {
    this.currentFocusIndex = results.length; // Position after all results
    this.updateFocus(dropdown.querySelectorAll(&quot;.search-result-item&quot;));
  });

  dropdown.appendChild(createNewItem);
}

addBand(band) {
  if (this.selectedBands.has(band.id.toString())) return;

  this.selectedBands.add(band.id.toString());
  this.bandsData.set(band.id.toString(), band);

  // Add to visual list
  const item = document.createElement(&quot;div&quot;);
  item.className = &quot;selected-band-item&quot;;
  item.id = `band-item-${band.id}`;

  // Band image
  const img = document.createElement(&quot;img&quot;);
  img.className = &quot;band-img&quot;;
  img.src = band.image_url || &quot;https://via.placeholder.com/40&quot;;
  img.alt = band.name;
  img.onerror = function () {
    this.src = &quot;https://via.placeholder.com/40&quot;;
  };

  // Band name and remove button container
  const itemContent = document.createElement(&quot;div&quot;);
  itemContent.className =
    &quot;d-flex justify-content-between align-items-center w-100 ms-2&quot;;

  // Band name
  const bandName = document.createElement(&quot;span&quot;);
  bandName.textContent = band.name;

  // Remove button with text
  const removeBtn = document.createElement(&quot;button&quot;);
  removeBtn.type = &quot;button&quot;;
  removeBtn.className = &quot;btn btn-sm btn-danger&quot;;
  removeBtn.innerHTML = &quot;Remove&quot;;
  removeBtn.dataset.id = band.id;
  removeBtn.dataset.action = &quot;click-&gt;band-selection#removeBand&quot;;
  removeBtn.setAttribute(&quot;title&quot;, &quot;Remove band&quot;);

  // Add elements to item
  itemContent.appendChild(bandName);
  itemContent.appendChild(removeBtn);
  item.appendChild(img);
  item.appendChild(itemContent);

  this.listTarget.appendChild(item);

  // Add hidden input
  const input = document.createElement(&quot;input&quot;);
  input.type = &quot;hidden&quot;;
  input.name = &quot;event[band_ids][]&quot;;
  input.value = band.id;
  input.id = `band-input-${band.id}`;
  this.idsContainerTarget.appendChild(input);

  // Update no bands message and count
  this.updateNoBandsMessage();
  this.updateSelectedCount();

  // Emit bands changed event
  this.emitBandsChangedEvent();
}

updateNoBandsMessage() {
  if (this.selectedBands.size === 0) {
    this.noMessageTarget.style.display = &quot;block&quot;;
  } else {
    this.noMessageTarget.style.display = &quot;none&quot;;
  }
}

updateSelectedCount() {
  if (this.hasCountTarget) {
    this.countTarget.textContent = this.selectedBands.size;
    this.countTarget.style.display =
      this.selectedBands.size &gt; 0 ? &quot;inline-block&quot; : &quot;none&quot;;
  }
}

// Emit an event whenever the selected bands change
emitBandsChangedEvent() {
  const selectedBandsArray = Array.from(this.bandsData.values());
  const event = new CustomEvent(&quot;band-selection:changed&quot;, {
    bubbles: true,
    detail: {
      bands: selectedBandsArray,
    },
  });
  this.element.dispatchEvent(event);
}</pre>

<p>}</p>

</main>

